---
layout: post
title: "一文了解所有常见共识算法"
description: "介绍所有常见的共识算法，包括PoW、PoS、DPoS等"
date: 2025-03-12T13:14:58+08:00
image: "/posts/blockchain/images/chapter_2-cover.jpg"
tags: ["Blockchain"]
---
## 什么是共识算法？

共识算法（Consensus Algorithm）​是分布式系统中所有节点就某一数据状态或交易顺序达成一致的规则和协议。

1982年，莱斯利·兰伯特（Leslie Lamport）提出“<a href="https://en.wikipedia.org/wiki/Byzantine_fault">拜占庭将军问题</a>”，研究分布式系统如何容错。该问题以一群将军通过信使传递消息，来投票决定是否进攻和撤离为背景，由于将军中可能存在叛徒，进行恶意投票或假冒其他将军投票，又或者消息在传递途中丢失或被替换，最终导致军队无法协同作战。

<div class="content-image">
<img src="/posts/blockchain/images/chapter_2-byzantine-generals.jpg" width="80%">
<p>Byzantine Generals</p>
</div>

在计算机系统中，将军就是网络节点，信使就是通信系统。如何确保即使在网络不可靠、存在延迟或部分节点恶意的情况下，所有诚实节点仍能同步并认可同一份“正确”的数据或交易状态，该问题涉及信息安全，但仅仅依赖数字签名无法解决，因为数字签名只能验证消息的完整性和来源，但无法鉴别恶意节点主动发送错误信息，为此我们需要共识算法。

## 区块链中的共识算法

共识算法是让一群互不信任的人在分布式网络中达成一致的工具，确保区块链在没有中心化控制的情况下安全、公平地运行，决定了谁有权生成新区块（记账权），以及如何验证区块的有效性。

### PoW（Proof of Work）

节点通过解决复杂的数学难题来竞争出块权，最先解决问题的节点获得出块权。其特点是低效、高能耗、高中心化，安全性依赖算力，适用于公链和价值存储。

### PoS（Proof of Stake）

通过节点持有的代币数量和时间（权益）来分配出块权。与工作量证明 PoW 不同，PoS 不需要节点进行复杂的计算，而是根据其持有的代币来随机选择出块节点，但可能导致富者愈富。其特点是中效、低能耗、中等中心化，安全性依赖代币持有量，适用于公链、金融应用和社区治理场景。

### DPoS（Delegated Proof of Stake）​

旨在通过代币持有者的投票选举出块节点（称为“见证人”或“代表”），由这些节点负责验证交易和生成区块。DPoS 是对传统权益证明 PoS 的改进，通过引入委托机制提高了网络的效率和去中心化程度。其特点是高效、低能耗、高中心化，安全性依赖见证人的可信度，适用于公链和社区治理场景。

### PoA（Proof of Authority）​

由预先授权的节点负责出块，通过预先授权的节点（称为“权威节点”或“验证者”）来验证交易和生成区块。与 PoW 和 PoS 不同，PoA 的核心思想是信任被授权的节点，而不是通过算力或代币持有量来竞争出块权。其特点是高效、低能耗、高中心化，安全性依赖验证者的可信度，适用于联盟链、私有链和测试网络。

### PoET（Proof of Elapsed Time）

旨在通过公平的随机选择方式确定出块节点，同时降低能耗。PoET 由英特尔（Intel）提出，基于可信执行环境（Trusted Execution Environment, TEE）技术，确保节点在等待随机时间后获得出块权。其特点是高效、低能耗、中等中心化，安全性依赖 TEE 技术，适用于联盟链、私有链和物联网。

### PoH（Proof of History）

由 Solana 项目提出，旨在通过时间戳序列证明事件发生的顺序，从而提高共识效率和网络的可扩展性。PoH 并不是一个独立的共识算法，而是与 PoS 结合使用，PoS 负责选择出块节点，而 PoH 负责验证事件顺序，为区块链提供高效的时间排序和验证机制。尽管 PoH 依赖时间同步，且技术复杂性较高，但其高效性和安全性使其成为区块链领域的重要创新。其特点是高效、低能耗、低中心化，安全性依赖时间戳序列，适用于公链和金融应用。

### PoSpace（Proof of Space）

通过节点提供的存储空间大小来竞争出块权。与工作量证明 PoW 依赖计算能力不同，PoSpace 利用节点的存储资源来确保网络的安全性和去中心化。PoSpace 的目标是降低能耗，同时提供高效的共识机制。其特点是中效、低能耗、中等中心化，安全性依赖于存储空间，适用于公链、存储网络和物联网。

### PoB（Proof of Burn）

通过节点销毁代币来证明其参与共识的意愿，并获得出块权。PoB 的核心思想是“燃烧”代币（即将其发送到一个无法访问的地址），以展示节点对网络的承诺和投入。PoB 的目标是提供一种公平且去中心化的共识机制，同时避免 PoW 的高能耗问题。尽管其代币销毁和中心化风险较高，但其公平性和去中心化特性使其成为区块链领域的重要创新。其特点是中效、低能耗、中等去中心化，安全性依赖代币销毁，适用于公链和社区治理。

### PoC（Proof of Capacity）

通过节点提供的存储容量来竞争出块权。与工作量证明 PoW 依赖计算能力不同，PoC 利用节点的存储资源来确保网络的安全性和去中心化。PoC 的目标是降低能耗，同时提供高效的共识机制。其特点是中效、低能耗、中等去中心化，安全性依赖存储容量。

### Paxos

Paxos 由 Leslie Lamport 在 1990 年提出，旨在解决分布式系统中多个节点就某个值达成一致的问题。Paxos 是分布式计算领域的重要算法之一，被广泛应用于分布式数据库、分布式存储系统和区块链等领域。

Paxos 算法分为两个阶段：准备阶段和接受阶段。

* 准备阶段（Prepare Phase）​
    * ​提议者（Proposer）​向​接受者（Acceptor）​发送准备请求（Prepare Request），包含一个提议编号（Proposal Number）。
    * ​接受者​收到准备请求后，如果提议编号大于之前接受的任何提议编号，则承诺不再接受更小的提议编号，并返回已接受的值（如果有）。
    * ​提议者​收集大多数接受者的响应，如果发现有已接受的值，则选择该值作为提议值。
* 接受阶段（Accept Phase）​
    * 提议者​向​接受者​发送接受请求（Accept Request），包含提议编号和提议值。
    * ​接受者收到接受请求后，如果提议编号大于等于其承诺的最小提议编号，则接受该提议值。
    * ​提议者​收集大多数接受者的接受响应，如果达到多数，则提议值被选定。

### Raft

Raft 由 Diego Ongaro 和 John Ousterhout 在 2014 年提出，旨在简化分布式系统中多个节点就某个值达成一致的过程。Raft 是 Paxos 的替代方案，通过将共识过程分解为更易理解的模块，降低了算法的复杂性，同时保持了高容错性和一致性。

Raft 算法分为三个主要模块：领导者选举、日志复制和安全性。

* 领导者选举（Leader Election）​
    * 节点启动时处于 ​Follower 状态，等待来自领导者的心跳消息。
    * 如果 Follower 在超时时间内未收到心跳消息，则转换为 ​Candidate 状态，并开始选举。
    * Candidate 向其他节点发送投票请求（RequestVote RPC），如果获得大多数节点的投票，则成为 ​Leader。
    * Leader 定期向其他节点发送心跳消息，以维持其领导地位。
* 日志复制（Log Replication）
    * Leader 接收客户端请求，并将其追加到本地日志中。
    * Leader 将日志条目发送给其他节点（AppendEntries RPC），要求其复制日志条目。
    * 其他节点将日志条目追加到本地日志中，并向 Leader 发送确认消息。
    * 当日志条目被大多数节点复制后，Leader 将其应用到本地状态机中，并通知客户端操作成功。
* 安全性（Safety）
    * Raft 通过​领导者选举限制和​日志匹配特性确保安全性。
    * 领导者选举限制：只有拥有最新日志的节点才能成为 Leader。
    * 日志匹配特性：如果两个节点的日志在某个索引处的条目相同，则它们在该索引之前的所有条目也相同。

### BFT 家族

拜占庭容错（Byzantine Fault Tolerance, BFT）​ 是一种分布式系统共识机制，能够在存在拜占庭故障（Byzantine Fault）的情况下，确保系统的一致性。拜占庭故障是指节点可能以任意方式故障，包括发送错误信息、不响应或恶意行为。BFT 的目标是确保系统在存在恶意节点的情况下仍能达成一致，**其能够容忍的恶意节点数量通常不超过总节点数的1/3**。

BFT 算法通常包括以下几个步骤：

* ​提议阶段（Proposal Phase）​：
    一个节点（提议者）向其他节点广播一个提议值。
* ​预投票阶段（Pre-Vote Phase）​：
    其他节点对提议值进行预投票，表示是否支持该提议值。
* ​投票阶段（Vote Phase）​：
    如果提议值获得足够的预投票支持，节点对其进行正式投票。
* ​提交阶段（Commit Phase）​：
    如果提议值获得足够的正式投票支持，节点将其提交到本地状态机中。
* ​学习阶段（Learn Phase）​：
    节点学习已提交的值，并将其广播到整个系统。

#### PBFT

PBFT（Practical Byzantine Fault Tolerance）​ 是一种实用的拜占庭容错算法，由 Miguel Castro 和 Barbara Liskov 在 1999 年提出。它是第一个能够在异步网络中实现拜占庭容错的实用算法，适用于分布式系统在存在恶意节点的情况下仍能达成一致。

PBFT 算法通过多轮消息传递和投票机制达成共识。其核心流程包括以下几个阶段：

* 请求阶段（Request Phase）​：
    客户端向主节点（Primary）发送请求，请求执行某个操作。
* 预准备阶段（Pre-Prepare Phase）​：
    主节点接收到请求后，广播一个预准备消息（Pre-Prepare Message）给所有副本节点（Replicas）。预准备消息包含请求的详细信息和一个序列号（Sequence Number）。
* 准备阶段（Prepare Phase）​：
    每个副本节点接收到预准备消息后，验证其有效性。如果验证通过，副本节点广播一个准备消息（Prepare Message）给其他副本节点。准备消息表明该节点支持主节点的提议。
* 提交阶段（Commit Phase）​：
    当副本节点收到足够多的准备消息（通常为 2f+1，其中 f 是恶意节点数），它广播一个提交消息（Commit Message）给其他副本节点。提交消息表明该节点已经准备好执行请求。
* 回复阶段（Reply Phase）​：
    当副本节点收到足够多的提交消息（通常为 2f+1），它执行请求并将结果发送给客户端。客户端收到足够多的相同结果后，确认请求已完成。

#### Tendermint

Tendermint 是一种高效、安全的拜占庭容错（BFT）共识算法和区块链框架，由 ​Jae Kwon 在 2014 年提出。Tendermint 结合了 ​权益证明（Proof of Stake, PoS）​ 和 ​拜占庭容错（BFT）​ 机制，旨在解决传统区块链的可扩展性、安全性和去中心化问题。Tendermint 是 ​Cosmos 网络 的核心共识引擎，被广泛应用于区块链开发和跨链互操作领域。

其核心思想是通过多轮投票和签名，快速达成网络共识。Tendermint 的共识流程包括以下几个阶段：

* 提案阶段（Propose Phase）​：
    轮值主节点（Proposer）提出一个新的区块，并将其广播给所有验证者节点（Validators）。
* 预投票阶段（Pre-Vote Phase）​：
    验证者节点接收到提案后，验证其有效性，并广播一个预投票消息（Pre-Vote Message）给其他节点。预投票消息表明该节点支持主节点的提案。
* 预提交阶段（Pre-Commit Phase）​：
    当验证者节点收到足够多的预投票消息（通常为 2f+1，其中 f 是恶意节点数），它广播一个预提交消息（Pre-Commit Message）给其他节点。预提交消息表明该节点已经准备好提交提案。
* 提交阶段（Commit Phase）​：
    当验证者节点收到足够多的预提交消息（通常为 2f+1），它广播一个提交消息（Commit Message）给其他节点。提交消息表明该节点已经提交提案。
* 决定阶段（Decide Phase）​：
    当验证者节点收到足够多的提交消息（通常为 2f+1），它执行提案并将结果应用到本地状态。

#### ​Algorand

Algorand 是一种高效、去中心化的区块链协议，采用​纯权益证明（Pure Proof of Stake, PPoS）、​加密抽签（Cryptographic Sortition）和拜占庭容错机制，确保去中心化和高效性，由麻省理工学院教授 Silvio Micali 于 2017 年提出。Algorand 旨在解决传统区块链技术中的性能、可扩展性和去中心化问题，通过独特的共识机制和加密技术，实现快速、安全且无需许可的区块链网络。

Algorand 其共识流程分为以下几个阶段：

* 加密抽签：
    每个持币者根据其持有的代币数量，通过加密抽签算法随机选择成为​提议者（Proposer）或​验证者（Verifier）​。抽签过程是概率性的，持币越多，被选中的概率越高。
* 区块提议：
    被选中的提议者负责提出一个新区块，并将其广播给网络中的其他节点。
* 软投票（Soft Vote）​：
    验证者对提议的区块进行验证，并投票支持最有效的区块。通过多轮投票，网络达成对区块的初步共识。
* 最终投票（Certify Vote）​：
    验证者对初步共识的区块进行最终确认，确保其有效性和安全性。一旦区块获得足够多的投票，它将被添加到区块链中。
* 快速终局性：
    Algorand 的区块在生成后立即被确认，无需等待多个区块确认，确保交易的快速终局性。

#### Avalanche

Avalanche 是一种创新的区块链协议，由 ​Team Rocket 在 2018 年提出，并于 2020 年正式发布。Avalanche 旨在解决传统区块链的可扩展性、去中心化和安全性问题，通过独特的共识机制和架构设计，实现高性能、低延迟的区块链网络。

Avalanche 采用​雪崩协议（Avalanche Consensus）​，这是一种基于​亚稳态（Metastability）​、​随机抽样（Random Sampling）和拜占庭容错的共识机制。其核心思想是通过多轮随机抽样和投票，快速达成网络共识。

雪崩协议的特点包括：

* 亚稳态：
    在网络中，节点通过多轮随机抽样和投票，逐步收敛到一个稳定的共识状态。
* ​随机抽样：
    每个节点随机选择一组其他节点进行投票，确保共识的高效性和去中心化。
* 快速终局性:
    雪崩协议能够在 1-2 秒内确认交易，提供近乎实时的交易体验。

#### HotStuff

HotStuff 是一种高效的拜占庭容错（BFT）共识算法，由 VMware Research 团队在 2019 年提出。它被设计用于解决传统 BFT 共识算法（如 PBFT）的复杂性和性能瓶颈问题，特别适用于大规模分布式系统。HotStuff 的核心思想是通过 ​链式结构（Chaining）​和​流水线化（Pipelining）​设计，显著提高共识效率和可扩展性。HotStuff 是 Facebook 的区块链项目 ​Libra（现为 Diem）​的核心共识算法。

HotStuff 的共识流程基于链式结构和流水线化设计，其核心思想是将共识过程分为多个阶段，并通过链式结构将这些阶段串联起来。其共识流程包括以下几个阶段：

* 提案阶段（Propose Phase）​：
    主节点（Leader）提出一个新的区块，并将其广播给所有副本节点（Replicas）。
* 准备阶段（Prepare Phase）​：
    副本节点接收到提案后，验证其有效性，并广播一个准备消息（Prepare Message）给其他节点。准备消息表明该节点支持主节点的提案。
* 预提交阶段（Pre-Commit Phase）：​
    当节点收到足够多的准备消息（通常为 2f+1，其中 f 是恶意节点数），它广播一个预提交消息（Pre-Commit Message）给其他节点。预提交消息表明该节点已经准备好提交提案。
* 提交阶段（Commit Phase）​：
    当节点收到足够多的预提交消息（通常为 2f+1），它广播一个提交消息（Commit Message）给其他节点。提交消息表明该节点已经提交提案。
* 决定阶段（Decide Phase）​：
    当节点收到足够多的提交消息（通常为 2f+1），它执行提案并将结果应用到本地状态。
